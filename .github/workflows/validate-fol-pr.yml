name: Validate FOL with Check Run

on:
    pull_request:
        branches: [main]
        paths:
            - "fol/**/*.fol"

jobs:
    validate-fol:
        runs-on: ubuntu-latest

        permissions:
            contents: read
            checks: write # Check Runì— ê¼­ í•„ìš”í•œ ê¶Œí•œ
            pull-requests: read

        steps:
            - name: Checkout repo
              uses: actions/checkout@v3
              # ì €ì¥ì†Œì˜ ìµœì‹  ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.

            - name: Get changed .fol files
              id: diff
              run: |
                  git fetch origin ${{ github.event.pull_request.base.ref }}
                  CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} -- 'fol/**/*.fol')
                  echo "changed_files<<DELIM_CHANGED" >> $GITHUB_OUTPUT
                  echo "$CHANGED" >> $GITHUB_OUTPUT
                  echo "DELIM_CHANGED" >> $GITHUB_OUTPUT

            - name: Fail early if no .fol files changed
              if: ${{ steps.diff.outputs.changed_files == '' }}
              run: |
                  echo "No .fol file changes detected. Skipping validation."
              # ë³€ê²½ëœ .fol íŒŒì¼ì´ ì—†ìœ¼ë©´ ê²€ì¦ ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ê³ , ì´í›„ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

            - name: Build JSON payload & summary
              id: build
              run: |
                  FILE_LIST=$(echo "${{ steps.diff.outputs.changed_files }}" | tr '\n' ' ')
                  PAYLOAD="{\"files\":["
                  SUMMARY=""
                  for file in $FILE_LIST; do
                    ENCODED=$(jq -Rs < "$file")
                    PAYLOAD="${PAYLOAD}{\"path\":\"$file\",\"content\":${ENCODED}},"

                    SUMMARY="${SUMMARY}\nğŸ“„ *${file}*"
                    CONSTANTS=$(grep -v '^#' "$file" | grep -E '^[A-Z][A-Za-z0-9]*$' || true)
                    PREDICATES=$(grep -E '^[A-Za-z0-9_]+\(' "$file" | cut -d'(' -f1 | sort | uniq || true)
                    FACTS=$(grep -E '^[A-Za-z0-9_]+\([A-Za-z0-9_, ]+\)' "$file" || true)

                    if [ -n "$CONSTANTS" ]; then
                      SUMMARY="${SUMMARY}\n- Constants: \`$(echo "$CONSTANTS" | tr '\n' ', ' | sed 's/, $//')\`"
                    fi
                    if [ -n "$PREDICATES" ]; then
                      SUMMARY="${SUMMARY}\n- Predicates: \`$(echo "$PREDICATES" | tr '\n' ', ' | sed 's/, $//')\`"
                    fi
                    if [ -n "$FACTS" ]; then
                      SUMMARY="${SUMMARY}\n- Facts: $(echo "$FACTS" | wc -l | xargs) assertions"
                    fi
                  done
                  PAYLOAD="${PAYLOAD%,}]}"
                  echo "$PAYLOAD" > payload.json

                  echo "summary<<DELIM_SUMMARY" >> $GITHUB_OUTPUT
                  echo "$SUMMARY" >> $GITHUB_OUTPUT
                  echo "DELIM_SUMMARY" >> $GITHUB_OUTPUT

            - name: Call FOL validation webhook
              id: call_webhook
              run: |
                  STATUS=$(curl -s -o response.json -w "%{http_code}" \
                    -X POST https://imperator-of-mars.ainetwork.xyz/api/validate-fol \
                    -H "Content-Type: application/json" \
                    -d @payload.json)

                  echo "status=$STATUS" >> $GITHUB_OUTPUT
                  echo "body<<DELIM_BODY" >> $GITHUB_OUTPUT
                  cat response.json >> $GITHUB_OUTPUT
                  echo "DELIM_BODY" >> $GITHUB_OUTPUT

            - name: Report Check Run (Pass)
              if: ${{ steps.call_webhook.outputs.status == '200' }}
              uses: LouisBrunner/checks-action@v1.6.0
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  name: FOL Consistency Check
                  conclusion: success
                  output: |
                      {
                        "title": "âœ… .fol ì •í•©ì„± ê²€ì‚¬ í†µê³¼",
                        "summary": "ëª¨ë“  .fol íŒŒì¼ì´ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤.",
                        "text": "${{ steps.build.outputs.summary }}"
                      }
              # ê²€ì¦ ì›¹í›…ì´ 200 ìƒíƒœ ì½”ë“œë¥¼ ë°˜í™˜í•˜ë©´ ì„±ê³µí•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ê³ , ì„±ê³µ ìƒíƒœì˜ Check Runì„ ë³´ê³ í•©ë‹ˆë‹¤.

            - name: Report Check Run (Fail)
              if: ${{ steps.call_webhook.outputs.status != '200' }}
              uses: LouisBrunner/checks-action@v1.6.0
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  name: FOL Consistency Check
                  conclusion: failure
                  output: |
                      {
                        "title": "âŒ .fol ì •í•©ì„± ê²€ì‚¬ ì‹¤íŒ¨",
                        "summary": "Webhook ì‘ë‹µ ìƒíƒœ: ${{ steps.call_webhook.outputs.status }}",
                        "text": "${{ steps.call_webhook.outputs.body }}"
                      }
              # ì›¹í›…ì˜ ì‘ë‹µ ìƒíƒœ ì½”ë“œê°€ 200ì´ ì•„ë‹ˆë©´ ì‹¤íŒ¨í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ì—¬, ì‹¤íŒ¨ ìƒíƒœì˜ Check Runì„ ë³´ê³ í•©ë‹ˆë‹¤.

            - name: Fail workflow on validation error
              if: ${{ steps.call_webhook.outputs.status != '200' }}
              run: exit 1
              # ìµœì¢…ì ìœ¼ë¡œ ê²€ì¦ ì‹¤íŒ¨ ì‹œ, ì›Œí¬í”Œë¡œìš° ì „ì²´ë¥¼ ì‹¤íŒ¨ ì²˜ë¦¬í•˜ì—¬ ë¨¸ì§€ê°€ ì•ˆë˜ë„ë¡ í•©ë‹ˆë‹¤.
